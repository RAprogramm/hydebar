Принято. Ниже — готовые **task-промпты для Codex**, без системного вступления, только то, что вставлять в задачу. Копируй, подставляй <> и жми. Комментарии в коде — на английском; версии и changelog не трогать.

---

## 1) Фича: новый модуль (hydebar-mod-<name>)

```
ЗАДАЧА: Реализовать модуль <name> для Hyprland-панели (hydebar), UI через iced, слой iced_layershell.

СКОУП:
- Ввести модульный контракт: Module/ModuleConfig/ModuleEvent уже в проекте; следовать ему.
- Реализовать модуль hydebar-mod-<name>: локальная модель, init с подписками/таймером, неблокирующая очередь событий.
- Добавить view-адаптер в hydebar-gui (без прямых вызовов iced из модуля).
- Конфиг: схема, валидация, hot-reload изменяет только этот модуль.

ВНЕ СКОУПА: версия crates/toolchain, CHANGELOG, общий рефактор ядра.

AR/DoD:
- `cargo check && cargo test --all` зелёные, `cargo fmt --all && cargo clippy --all-targets -- -D warnings` чисто.
- Модуль включается/выключается из конфига; при невалидном конфиге модуль не падает, логирует ошибку и сохраняет предыдущее состояние.
- События модуля: DataUpdated/Redraw/PopupToggle; без panic/unwrap/unsafe, минимум clone().

ПЛАН:
1) Создать крейт/модуль hydebar-mod-<name>, описать Config + Validate.
2) Реализовать Module/Ticked: init, poll, on_tick, reconfigure, shutdown.
3) hydebar-gui: добавить View/Message-мост, батчить Redraw.
4) Конфиг-схема + hot-reload.
5) Юнит-тесты на логику; интеграционный на событие→GUI.

ТОЧКИ ИЗМЕНЕНИЙ:
- crates/hydebar-mod-<name>/**
- crates/hydebar-gui/src/views/<name>.rs
- crates/hydebar-core/src/registry.rs (регистрация)
- crates/hydebar-core/src/config/schema/<name>.json / examples/*.toml

КОМАНДЫ: `cargo check && cargo test --all && cargo fmt --all && cargo clippy --all-targets -- -D warnings`

ВЫВЕДИ ТОЛЬКО ПЛАН ИЗМЕНЕНИЙ И DoD, затем жди ACK.
```

---

## 2) Фича: попап у существующего модуля

```
ЗАДАЧА: Добавить popup UI для модуля <name> (iced + iced_layershell), без блокировок рендера.

СКОУП:
- В модуле: сигнал PopupToggle и модель для детального состояния.
- В GUI: общее окно popup через layershell-адаптер, открытие по событию, закрытие по esc/вне-клика/таймеру.
- Батчить Redraw; не трогать другие модули.

AR/DoD:
- Popup открывается/закрывается без утечек и подвисаний; позиционируется относительно панели.
- Никаких глобальных стейтов; события через общий event-bus.
- Тест: симулировать PopupToggle, убедиться, что создаётся/удаляется представление.

ПЛАН:
1) Модуль <name>: добавить событие PopupToggle и расширить модель данных.
2) GUI: общий PopupManager, слой, фокус/esc, auto-close.
3) Мини-тесты на логику; ручная проверка.

ТОЧКИ ИЗМЕНЕНИЙ: crates/hydebar-mod-<name>/**, crates/hydebar-gui/src/popup/**, crates/hydebar-gui/src/app.rs

КОМАНДЫ: `cargo check && cargo test --all && cargo fmt --all && cargo clippy -- -D warnings`

Выведи план и DoD, дождись ACK.
```

---

## 3) Рефактор: выделить порт Hyprland

```
ЗАДАЧА: Вынести Hyprland-интеграцию в порт (trait + адаптер), убрать прямые вызовы из модулей/GUI.

СКОУП:
- В hydebar-proto: ввести trait HyprlandPort (события workspaces/windows, запросы).
- В hydebar-core: адаптер на hyprland-rs с таймаутами/ретраями.
- Обновить места прямых обращений к hyprland-rs на использование порта.

ВНЕ СКОУПА: новые фичи, изменение поведения UI.

AR/DoD:
- Поведение неизменно (скриншоты/логика прежние).
- Тесты зелёные, clippy/rustfmt чисто.
- hyprland-rs скрыт за портом; модулей это не касается.

ПЛАН:
1) Trait HyprlandPort в hydebar-proto.
2) Адаптер в hydebar-core (ретраи, таймауты, логирование).
3) Миграция вызовов по участкам, удаление прямых зависимостей.
4) Тест/проверка.

ИЗМЕНЕНИЯ: crates/hydebar-proto/src/ports/**, crates/hydebar-core/src/adapters/hyprland/**, обновления imports в модулях.

КОМАНДЫ: стандартный набор (check/test/fmt/clippy).

Выведи план и DoD, жди ACK.
```

---

## 4) Горячая перезагрузка конфига

```
ЗАДАЧА: Реализовать hot-reload конфигов модулей с безопасной валидацией и частичной перезагрузкой.

СКОУП:
- Схемы JSON/TOML, версия config_version.
- Валидатор + миграции vN→vN+1 (минимальные).
- Перезагружать только изменившиеся модули; при ошибке откатывать к предыдущей валидной конфигурации.

AR/DoD:
- Изменение файла конфига приводит к пересборке только затронутых модулей.
- Ошибки не валят процесс; логируется и сохраняется прежнее состояние.
- Тесты: валидный/невалидный конфиг, миграция.

ПЛАН:
1) Ввести Schema + Validate + Migrate.
2) Watch через notify; debounce.
3) Частичная перезагрузка, транзакционность.
4) Тесты.

ИЗМЕНЕНИЯ: crates/hydebar-core/src/config/**, crates/hydebar-core/src/config/schema/**, examples/**

КОМАНДЫ: стандартный набор.

Выведи план и DoD, жди ACK.
```

---

## 5) Производительность: батчинг Redraw

```
ЗАДАЧА: Снизить частоту перерисовок, внедрив батчинг Redraw и микро-тики.

СКОУП:
- В event-bus: лимит очереди, дроп частых Redraw, объединение событий в кадр.
- В GUI: микро-тикер (например, 16–33ms), единственный Redraw за тик.

AR/DoD:
- На сценарии <описать> количество Redraw снижается ≥ X%, UI без лагов и пропусков.
- Тесты/бенчи: измерение количества Redraw до/после, нет регрессий.

ПЛАН:
1) Лимит очереди, coalesce Redraw.
2) Микро-тикер в GUI.
3) Бенч/замер.

ИЗМЕНЕНИЯ: crates/hydebar-core/src/bus.rs, crates/hydebar-gui/src/app.rs

КОМАНДЫ: стандарт.

Выведи план и DoD, жди ACK.
```

---

## 6) Стабильность IPC: таймауты и ретраи

```
ЗАДАЧА: Обернуть все IPC/IO-вызовы Hyprland и системных сервисов таймаутами, ретраями, контекстным логированием.

СКОУП:
- Политика: таймаут T, ретраи N с backoff, метрики ошибок.
- Применить в HyprlandPort-адаптере и местах системных вызовов модулей.

AR/DoD:
- При недоступности IPC панель не зависает; модуль переходит в degraded state.
- Логи содержат причину и попытки; нет panic/unwrap.

ПЛАН:
1) Ввести util для retry/timeout.
2) Обернуть вызовы в адаптере.
3) Лёгкие интеграционные тесты-симуляторы.

ИЗМЕНЕНИЯ: crates/hydebar-core/src/adapters/**, crates/hydebar-core/src/utils/**

КОМАНДЫ: стандарт.

Выведи план и DoD, жди ACK.
```

---

## 7) Багфикс: гонка/утечка в модуле

```
БАГ: <описание + репро>
ПРИЧИНА (гипотеза): <…>

ИСПРАВЛЕНИЕ (СКОУП):
- Устранить гонку/утечку за счёт <канала/Arc<Mutex>/stream cancel/Drop>.
- Привести владение/жизненный цикл к единому контракту модуля.

AR/DoD:
- Репро-тест красный до фикса, зелёный после.
- Инструментальная проверка (valgrind/якорные метрики) без утечек.
- Без паник и unwrap.

ПЛАН:
1) Добавить тест, воспроизводящий проблему.
2) Исправить владение/отписки/Drop.
3) Повторные тесты.

ИЗМЕНЕНИЯ: crates/hydebar-mod-<name>/**

КОМАНДЫ: стандарт.

Выведи план и DoD, жди ACK.
```

---

## 8) Рефактор: разрез монолита на крейты

```
ЗАДАЧА: Разбить репозиторий на workspace: hydebar-proto, hydebar-core, hydebar-gui, hydebar-mod-*, без изменения поведения.

СКОУП:
- Вынести общие типы/трейты в hydebar-proto.
- Ядро (event-bus, registry, конфиг) в hydebar-core.
- GUI в hydebar-gui.
- Приложение-обёртка и CLI в hydebar-app.
- Модули в отдельные крейты.

AR/DoD:
- Поведение идентично; тесты зелёные; docs обновлены.
- Внешние публичные API прежние.

ПЛАН:
1) Создать workspace, переместить код.
2) Правки путей/импортов.
3) Тест/валидация.

ИЗМЕНЕНИЯ: Cargo.toml/workspace, crates/**

КОМАНДЫ: стандарт.

Выведи план и DoD, жди ACK.
```

---

## 9) DX: шаблон модуля и генератор

```
ЗАДАЧА: Добавить rust-шаблон и cargo-генератор для нового модуля hydebar-mod-<name>.

СКОУП:
- cargo xtask или cargo generate шаблон: минимальный модуль с Config/Module/Ticked; тесты-заглушки.
- Док из 1 страницы: как написать модуль за 10 минут.

AR/DoD:
- `cargo xtask new-module foo` создаёт рабочий модуль, собирается и виден GUI при подключении в конфиге.

ПЛАН:
1) Шаблон + скрипт генерации.
2) Док.

ИЗМЕНЕНИЯ: xtask/**, templates/hydebar-mod-template/**, docs/dev/modules.md

КОМАНДЫ: стандарт.
```

---

## 10) Тесты: интеграция событий модуля→GUI

```
ЗАДАЧА: Покрыть путь ModuleEvent→GUI Message интеграционными тестами.

СКОУП:
- Тест-харнесс, который фидит события модулей и проверяет, что GUI генерит ожидаемые iced::Message и перерисовку один раз за тик.

AR/DoD:
- Негативные кейсы: валидация ошибок без краша; coalesce Redraw проверяется.

ПЛАН:
1) Харнесс.
2) Позитив/негатив кейсы.
3) Замеры coalesce.

ИЗМЕНЕНИЯ: tests/integration/gui_events.rs, crates/hydebar-gui/src/app.rs (точки инъекции)

КОМАНДЫ: стандарт.
```

---

## 11) Конфиг-миграции

```
ЗАДАЧА: Ввести систему миграций config_version vN→vN+1 с безопасным откатом.

СКОУП:
- Таблица миграций, проверка схем, лог ошибок.
- Авто-бэкап предыдущей версии.

AR/DoD:
- Валидный апгрейд сохраняет семантику; невалидный откатывается.
- Тесты: апгрейд/даунгрейд/ошибка.

ПЛАН:
1) Каркас миграций.
2) Пара примерных миграций.
3) Тесты.

ИЗМЕНЕНИЯ: crates/hydebar-core/src/config/migrations/**

КОМАНДЫ: стандарт.
```

---

## 12) CI «качество на входе»

```
ЗАДАЧА: В CI добавить строгий гейт качества: check, test, fmt, clippy; артефакты логов на падении.

AR/DoD:
- PR без прохождения пайплайна не мёржится.
- Логи сборки/тестов доступны как артефакты.

ПЛАН:
1) Добавить workflow с шагами check/test/fmt/clippy.
2) Артефакты логов и junit (если есть).
3) Док коротко в CONTRIBUTING.md.

ИЗМЕНЕНИЯ: .github/workflows/ci.yml, CONTRIBUTING.md

КОМАНДЫ: n/a (это CI).

Выведи план и DoD, жди ACK.
```

---

Хватит, чтобы грузить Codex сутками и не развалить проект. Чёткие DoD, явный план, ограниченный скоуп, стандартный гейт. Если где-то начнёт «умничать» и лезть в версионирование — вставляй эту фразу в конец промпта: **«Запрещено менять версии crates/toolchain и править CHANGELOG/Cargo.lock без отдельной задачи.»**
